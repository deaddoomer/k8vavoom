<html>
<head>
<title>3D Polyobject specification for k8vavoom engine, v0.99</title>
<style>
.content {
  /*width: 42em;*/
}
.toc {
  background: #aaa; /* sorry for this */
  padding: 6px;
  border: solid 1px black;
  width: 50%;
}
hr {
  margin: 12px;
  padding: 0px;
}
h1 {
  font-size: 160%;
  text-align: center;
  margin: 12px;
  padding: 0px;
}
h2 {
  font-size: 180%;
  text-align: center;
  margin: 12px;
  padding: 0px;
}
pre {
  background: #aaa; /* sorry for this */
}
</style>
<body>
<div class="content">
<h2>3D Polyobject specification for k8vavoom engine, v0.99</h2>
<p>
This is description of k8vavoom 3d polyobjects: how to create them, how to
use them, and, most important, how to NOT use them.
</p>

<p>
Think of 3D polyobject as if it is a moving solid sector. Normal Doom
sectors are empty inside, i.e. they have empty space between their floors
and ceilings. 3D polyobject is the inverse of that: it has solid space
between its floor and ceiling, and you can stand on its ceiling (which
will look like platform floor for the player).
</p>

<b>TOC</b><br>
<div class="toc">
<a href="#drawit">How to draw 3d polyobject</a><br>
<a href="#spawnit">How to spawn 3d polyobject</a><br>
<a href="#setheight">How to set 3d polyobject height (and texture parameters meaning)</a><br>
<a href="#linkit">Linked 3d polyobjects</a><br>
<a href="#movenote">Notes about movement</a><br>
<a href="#acsapi">New ACS API</a><br>
<a href="#limitations">Current Limitations</a><br>
</div>


<hr>
<a id="drawit"></a><h1>How to create 3d polyobject</h1>
<p>
Drawing 3d polyobjects is very easy, it is not much different from
drawing a standard polyobject. Please, refer to any polyobject
documentation. I will only describe the differences here.
</p>

<p>
Each 3d polyobject should consist of one sector, created with closed contours.
The shape and the number of the contours can be arbitrary, as long as all contours
are closed, and there are no self-intersections. All lines should point <b>outside</b>
of that "inner" sector, and should be marked as "impassable". Of course, those lines
should be two-sided. ;-)
</p>

<p>
Please, note that breaking any requirement may lead to undefined result. I.e. your
invalid 3d polyobject may work, and you may even get some fancy effects, but there are
no guarantees that it will keep working in any following engine build.
<div style="font-size:140%;color:#c00;">
<b>PLEASE, DON'T DO ANYTHING THAT IS NOT EXPLICITLY DESCRIBED AS ALLOWED IN THIS DOCUMENT!</b>
</div>
</p>

<p>
Here is the picture for you.
</p>
<img src="fig1.png" />

<p>
There are two sectors on the picture. "Inner sector" is 3d polyobject sector. As you can see,
its shape is not convex, but it is closed, and all lines points outside of it. The outer sector
is just a "container" for polyobject. It will not be visible in-game.
</p>
<p>
You can place normal polyobject anchor thing to mark the anchor point of your 3d polyobject.
If you will not do it, the engine will select some point on its own. It will try to select a
point close to polyobject center, but it is not guaranteed. The algorithm to calculate center
point may change in the future, so you should <b>ALWAYS</b> use anchor things.
</p>
<p>
Inner sector height will be used as 3d polyobject height. But please, note that maximum height is
limited by middle texture height, if you won't set your middle texture as wrapping. Inner sector
floor texture will be the bottom 3d polyobject texture, and ceiling texture will become the top one.
</p>
<p>
To align floor and ceiling textures, just align your inner sector as you want to. The inner sector
will be "cut out" as it is, and will retain its flat align no matter how you'll move it.
</p>
<p>
You can set top and bottom textures for 3d polyobject lines. Top texture can be made impassable by
setting "clip midtexture" line flag. Impassable top textures should be assigned to the both line
sides, and should be of the same height, or the engine will refuse loading a map. Bottom texture
is just a decoration and will not block movement.
</p>
<p>
Note that top texture is always mapped from 3d polyobject ceiling up, and bottom texture is always
mapped from 3d polyobject floor down.
</p>
<p>
You can use "midtexture is wrapped" flag to tell the engine that middle texture should be wrapped.
Note that all middle textures should be high enough (or wrapped) to fill the whole side.
If this rule is violated, the engine will refuse loading a map.
</p>
<p>
Line alpha and additivenes can be used to control top/bottom texture rendering. Middle texture is
always non-alphablended. Do not assign translucent textures to midtex, or the engine will refuse
loading a map.
</p>
<p>
Currently you cannot assign "masked" middle texture (i.e. things like grates and such).
This limitation may be removed in the future.
</p>
<p>
3D polyobject light level is determined by the light level of its inner sector. Currently this is
the only thing that controls 3d polyobject ambient lighting.
</p>


<hr>
<a id="spawnit"><h1>How to spawn 3d polyobject</h1>
<p>
To spawn your 3d polyobject, you should use new thing with editor number <b>9369</b>.
It's height will specify initial z offset <b>from the inner sector</b>. NOT from the destination one!
The angle is the polyobject tag, as in other polyobject spawners.<br>
<b>arg1</b> is the sum of 3d pobj flags (see `<code>POBJ_FLAG_xxx</code>` below).<br>
<i>Note: if `<code>POBJ_FLAG_SIDE_CRUSH</code>` is set, entity will be destroyed if it was touched
by a moving 3d pobj side. This is useful to create vertical crushers, because otherwise crushing
3d pobj can try to push an entity away if it is close to the edge. Also, this flag does nothing if
`<code>POBJ_FLAG_CRUSH</code>` is not set.</i><br>
<b>WARNING! Other things args must be zero! They may be used later, and if you will not set them
to zeroes, your map may break in the future!</b>
</p>
<!--
<p>
Also, if anchor thing height is not zero, then 3d polyobject will be offset <b>from the destination sector</b>.
Positive anchor height will move 3d polyobject floor to the destination sector floor, and then will offset up.
Negative anchor height will move 3d polyobject ceiling to the destination sector ceiling, and then will offset down.
</p>
<p>
Note that anchor height will ignore any polyobject links. I.e. it is mostly usable for simple one-sector platforms,
not for complex multi-polyobject structures.
</p>
-->


<hr>
<a id="setheight"><h1>How to set 3d polyobject height</h1>
<p>
3D polyobject height is determined by two parameters: its inner sector, and middle texture of its
first line (at the front side).
</p>
<p>
First, 3d polyobject inner sector sets hard limits: 3d pobj cannot be higher than its inner sector.
</p>
<p>
Second, if the middle texture of the 3d polyobject first line is not wrapped, then the height is clamped
by that texture scaled height (i.e. UDMF Y scale value is in effect). if ML_DONTPEGBOTTOM flag is set,
then the texture goes from inner sector floor up, otherwise it goes from inner sector ceiling down (i.e.
that flag has the same meaning as for other two-sided lines).
</p>
<!--
Third, if anchor thing height is not zero, then 3d polyobject height will never be greater than its absolute value.
If the height is positive, then 3d polyobject floor will be raised, if necessary. And if the height is negative,
then 3d polyobject ceiling will be lowered, if necessary.
-->


<hr>
<a id="linkit"><h1>Linked 3d polyobjects</h1>
<p>
There is a new feature you can use to create complex structures out of simple polyobjects: polyobject links.
It is somewhat similar to linked sectors you could use to create complex lifts.
</p>
<p>
Linked polyobjects will behave as one object, and all operations on the first polyojbect in the link will
affect all linked "children". All operations on the link chain are atomic. I.e. if moving/rotating is failed,
no objects in chain will be modified. Just think about the link chain as one big object.
</p>
<p>
To link polyobjects, use things with editor id <b>9368</b>. Its first argument is a master polyobject id,
its second argument is a secondary polyobject id. It will link the secondary polyobject to the master.
Note that you cannot link two or more polyobject to one master, so to create complex structures you have
to link all polyobjects one to another, creating a "link chain". Linking all polyobjects to a single master
<b>will not work</b>.
</p>


<hr>
<a id="movenote"><h1>Notes about movement</h1>
<p>
You can move your 3d polyobject by all three axes, and it will carry all things standing on it. Currently
it works like a platform in arcade games: it carries things, but doesn't modify their velocities. This means
that if the player will jump while riding some 3d polyobject, the jump will be strictly vertical (and the
platform will move away). I may add flags to make "non-arcade" platforms later, but for now there is only
one platform type available.
</p>
<p>
Rotating 3d polyobject is allowed too. As you may expect, all things standing on such 3d polyobject will be
properly rotated. Floor and ceiling textures will be rotated too (around polyobject anchor point).
You can rotate 3d pobj only around Z axis (i.e. the same way non-3d pobjs are rotated). This limitation
won't be removed.
</p>
<p>
Currently, you cannot stack several entities on top of each other and make them move with the 3d polyobject.
I.e. some solid entity that is standing on some other solid entity will block the whole movement, and may
be crushed (because it is considered as "blocking" one).
</p>


<hr>
<a id="acsapi"></a><h1>New ACS API</h1>
<p>Assuming that you are using ZDoom ACC compiler fork, paste the following into your "zspecial.acs".</p>
</div>
<pre>
  // k8vavoom polyobjects
  // note that angles are in degrees
  // speed is in units per second
  // bool Polyobj_MoveEx (int po, int hspeed, int yawangle, int dist, int vspeed, int vdist, int moveflags)
  -800:Polyobj_MoveEx(7),
  // bool Polyobj_MoveToEx (int po, int speed, int x, int y, int z, int moveflags)
  -801:Polyobj_MoveToEx(6),
  // bool Polyobj_MoveToSpotEx (int po, int speed, int targettid, int moveflags) -- this uses target height too
  -802:Polyobj_MoveToSpotEx(4),
  // float GetPolyobjZ (int po)
  -803:GetPolyobjZ(1),
  // int Polyobj_GetFlagsEx (int po) -- -1 means "no pobj"
  -804:Polyobj_GetFlagsEx(1),
  // int Polyobj_SetFlagsEx (int po, int flags, int oper) -- oper: 0 means "clear", 1 means "set", -1 means "replace"
  -805:Polyobj_SetFlagsEx(3),
  // int Polyobj_IsBusy (int po) -- returns -1 if there is no such pobj
  -806:Polyobj_IsBusy(1),
</pre>
<div class="content">
<p>Assuming that you are using ZDoom ACC compiler fork, paste the following into your "zdefs.acs".</p>
</div>
<pre>
// for Polyobj_GetFlagsEx and Polyobj_SetFlagsEx
#define POBJ_FLAG_CRUSH            (1 << 0) /* 1 */
#define POBJ_FLAG_HURT_ON_TOUCH    (1 << 1) /* 2 */
#define POBJ_FLAG_NO_CARRY_THINGS  (1 << 2) /* 4 */
#define POBJ_FLAG_NO_ANGLE_CHANGE  (1 << 3) /* 8 */
#define POBJ_FLAG_SIDE_CRUSH       (1 << 4) /* 16 */

// for Polyobj_SetFlagsEx
#define POBJ_FLAGS_CLEAR    0
#define POBJ_FLAGS_SET      1
#define POBJ_FLAGS_REPLACE  -1

// for `moveflags`
#define POBJ_MOVE_NORMAL    0
#define POBJ_MOVE_OVERRIDE  (1 << 0)
#define POBJ_MOVE_NOLINK    (1 << 1)
</pre>
<div class="content">

<hr>
<a id="limitations"></a><h1>Current Limitations</h1>
<p>
Riding on the moving 3d polyobject is done by teleporting. It means that entities are not moved
by velocities or proper box tracing, they simply teleported to their destination. If the destination
is occupied, and it is impossible to make a valid step up (not a stair, or stairs are too high), the
entity will be returned to its original place. If returned entity blocks the polyobject, either the
polyobject will stop, or the entity will be squashed.
</p>
<p>
Due to the tepelorting, vertical entity "stacking" is not supported. I.e. you cannot put one entity on top
of another and make them both ride on a 3d polyobject: if an entity is moved to the place which is already
occupied by another entity, it will be processed as a normal blocking (see above).
</p>
<p>
Impassable top texture currently doesn't block hitscan attacks or projectile movement. Do not try to use
"blocks projectile" or other linedef flags yet, please -- they <b>may</b> work, but it is not guaranteed, and
may be changed in the future.
</p>
<p>
Also, please, set <b>only</b> "impassable" flag on 3d polyobject linedefs. Other flags may or may not work
properly, and nothing is guaranteed. Even if it seems to work now (or do nothing), the engine may refuse
to load such maps in the future, or flag meaning may change.
</p>
<p>
Currently you cannot assign "masked" or translucent middle texture (i.e. things like grates and such). This limitation
may be removed in the future.
</p>
<p>
Also, currently you cannot use "masked" or translucent floor/ceiling textures. This limitation may be removed in the future.
</p>
<p>
All middle textures should cover the full side (i.e. be either wrapped, or high enough).
</p>
<p>
Lightmapped lighting may glitch on 3d polyobjects. This will be fixed in the future.
</p>
<p>
Ambient lighting of 3d polyobject is controlled only by its inner sector light level. Moving 3d polyobject will not
"inherit" light level of the sector (or sectors) it is currently in. Dynamic light level change can be implemented
in the future, but it will be opt-in (i.e. there will be a special flag to turn it on).
</p>

</div>
<!-- TODO: document moving and checking order, so other sourceports will be able to implement it in compatible way -->
</body>
<html>